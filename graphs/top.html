<style>
  #topGraphLegend {
    max-width: 1000;
    margin: 0 auto;
  }
  .info {
    margin: 2px;
    margin-left: 4px;
    margin-right: 4px;
    padding-top: 8px;
  }
</style>
<script src="scripts/Smoothie.js"></script>
<h3>Gemiddelde winst per hand</h3>
<canvas id="topGraphCanvas" width="750" height="175"></canvas>
<div id="topGraphLegend"><span class="info"></span></div>
<div id="gpswarning" class="ui raised segment hideme">
  <p> Het gemiddelde aantal handen per seconde is enorm gedaald sinds de laatste
      regels. Om de snelheid optimaal te houden is het verstandig om de volgende
      regels simpeler te houden. </p>
</div>
<script>


  var fillcolor = 'rgba(0, 0, 0, 0)';
  var linewidth = 3;

  var tois = 1;
  var dataSets = null;
  var smoothie = null;
  var DATASOURCE = 'http://bear.cs.kuleuven.be/pokerdemo/server/ObserveTable.php?tableName=' + Client.table;

  var parseData = function(data) {
    var players = data['result']['player'];
    if (dataSets == null) {
      smoothie = new SmoothieChart({
        grid: {
          strokeStyle:'rgb(247, 247, 247)',
          fillStyle:'rgb(247, 247, 247)',
          lineWidth: 1,
          millisPerLine: 250,
          verticalSections: 6,
        }, labels: {
          disabled: true,
          fillStyle:'rgba(0, 0, 0, 0.25)',
          fontStyle: 'Arial'
        }
      });
      smoothie.streamTo(document.getElementById("topGraphCanvas"));
      dataSets = new Array(players.length);
      for(var i = 0; i < players.length; i++) {
        dataSets[i] = new TimeSeries();
        smoothie.addTimeSeries(dataSets[i], {
          strokeStyle: GRAPH_COLORS[i],
          fillStyle: fillcolor,
          lineWidth: linewidth
        });
      }
      smoothie.streamTo(document.getElementById('topGraphCanvas'), tois * 2000);
    }
    $('#topGraphLegend').html('');
    for(var i = 0; i < players.length; i++) {
      var player = players[i];
      dataSets[i].append(new Date().getTime(), Math.round(player['avg profit'] * 100) / 100);
      var description = '<span class="info" style="color:'+GRAPH_COLORS[i]+';">'+players[i]['name']+'</span>';
      $('#topGraphLegend').html($('#topGraphLegend').html() + description);
    }
    setTimeout(function() {
      fetchData();
    }, tois * 1000);
  }

  var fetchData = function() {
    $.ajax({ url: DATASOURCE, method: 'GET', success: function(result) {
      try {
        var data = $.parseJSON(result);
        var gps = parseFloat(data['gamesPerSec']);
        if (gps < 10 && $('#gpswarning').hasClass('hideme')) {
          $('#gpswarning').removeClass('hideme');
        } else if (gps > 10 && !$('#gpswarning').hasClass('hideme')) {
          $('#gpswarning').addClass('hideme');
        }
        Blockly.svgResize(workspace);
        parseData(data);
      } catch(error) {}
    }, error: function(error) {
      console.error('Unable to fetch data!: ' + error);
    }});
  }

  fetchData();

</script>
