<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Top Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="../scripts/Smoothie.js"></script>
  </head>
  <body>
    <canvas id="topGraphCanvas" width="1200" height="200"></canvas>
    <script>

      var colors = [
        'rgb(25, 180, 145)',
        'rgb(41, 197, 102)',
        'rgb(45, 141, 214)',
        'rgb(144, 79, 173)',
        'rgb(46, 64, 83)',
        'rgb(22, 150, 122)',
        'rgb(35, 164, 85)',
        'rgb(36, 117, 176)',
        'rgb(131, 60, 163)',
        'rgb(39, 54, 70)'
      ];
      var fillcolor = 'rgba(0, 0, 0, 0)';
      var linewidth = 3;

      var tois = 1;
      var dataSets = null;
      var DATASOURCE = 'http://bear.cs.kuleuven.be/pokerdemo/server/ObserveTable.php?tableName=Chilli';

      var parseData = function(data) {
        var players = data['result']['player'];
        if (dataSets == null) {
          var smoothie = new SmoothieChart();
          smoothie.streamTo(document.getElementById("topGraphCanvas"));
          dataSets = new Array(players.length);
          for(var i = 0; i < players.length; i++) {
            dataSets[i] = new TimeSeries();
            smoothie.addTimeSeries(dataSets[i], {
              strokeStyle: colors[i],
              fillStyle: fillStyle,
              lineWidth: lineWidth
            });
          }
          smoothie.streamTo(document.getElementById('topGraphCanvas'), tois * 2000);
        }
        for(var i = 0; i < players.length; i++) {
          var player = players[i];
          dataSets[i].append(new Date().getTime(), player['avg profit']);
        }
        setTimeout(function() {
          fetchData();
        }, tois * 1000);
      }

      var fetchData = function() {
        $.ajax({ url: DATASOURCE, method: 'GET', success: function(result) {
          try {
            var data = $.parseJSON(result);
            parseData(data);
          } catch(error) {
            console.error('Data received but error!: ' + error);
          }
        }, error: function(error) {
          console.error('Unable to fetch data!: ' + error);
        }});
      }

      fetchData();
      smoothie.addTimeSeries(line1,
        { strokeStyle:'rgb(0, 255, 0)', fillStyle:'rgba(0, 255, 0, 0.4)', lineWidth:3 });
    </script>
  </body>
</html>
