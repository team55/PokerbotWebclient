
<!--  This files uses the ChartJS library in order to display the different
      pie charts. Make sure to include version 1.0.2 or below. The minified
      file is added to the scripts folder. If this file is not included in the
      parent file, the charts won't appear and might even damage other parts
      of the webpage that require JavaScript. It also uses the Client instance
      from the main page to determine which user is currently connected.  -->

<h3>Rekentijd per speler</h3>
<canvas id="CalculationTime" width="125" height="125"></canvas>
<h3>Zetten van <span id="movesUsernameView"><span></h3>
<canvas id="MovesChart" width="125" height="125"></canvas>
<h3>Gevuurde regels van <span id="rulesUsernameView"></span></h3>
<canvas id="RulesChart" width="125" height="125"></canvas>

<script>

  // Define the charts to be in the global namespace.
  var calculationTimeChart = null;
  var movesChart = null;
  var rulesChart = null;

  /**
   *  Creates the calculationTimeChart with the data that is prepared by the
   *  parseCalculationTimePieChartData() function.
   */
  function createCalculationTimePieChart(data, total) {
    var information = [], i = 0;
    for(index in data) {
      var value = Math.round((data[index]/total)*100);
      var label = index + ' - ' + value + '%';
      var element = {
        value: value,
        color: COLORS[i],
        highlight: COLORS[i],
        label: label
      }
      information.push(element);
      i++;
    }
    var options = {
      tooltipTemplate: "<%= label %>",
      showTooltips: true,
      animation: false
    }
    if (calculationTimeChart != null) calculationTimeChart.destroy();
    var context = $('#CalculationTime').get(0).getContext('2d');
    calculationTimeChart = new Chart(context).Pie(information, options);
  }
  function parseCalculationTimePieChartData(raw) {
    var list = raw['result']['player'];
    var result = {};
    var total = 0;
    for(var i = 0; i < list.length; i++) {
      result[list[i]['name']] = list[i]['time used'];
      total += list[i]['time used'];
    }
    createCalculationTimePieChart(result, total);
  }

  /**
   *  Creates the movesChart with the data that is prepared by the
   *  parseMoveChartData() function. Also the username will be set in the
   *  movesUsernameView.
   */
  function createMovesChart(data, total) {
    $('#movesUsernameView').html(Client.username);
    var information = [], i = 0;
    for(index in data) {
      var value = Math.round((data[index]/total)*100);
      var label = index + ' - ' + value + '%';
      var element = {
        value: value,
        color: COLORS[i],
        highlight: COLORS[i],
        label: label
      }
      information.push(element);
      i++;
    }
    var options = {
      tooltipTemplate: "<%= label %>",
      showTooltips: true,
      animation: false
    }
    if (movesChart != null) movesChart.destroy();
    var context = $('#MovesChart').get(0).getContext('2d');
    movesChart = new Chart(context).Pie(information, options);
  }
  function parseMoveChartData(raw) {
    var list = raw['result']['player'];
    var result = {};
    var total = 0;
    for(var i = 0; i < list.length; i++) {
      if (list[i]['name'] == Client.username) {
        result['nbFolds'] = list[i]['nbFolds'];
        result['nbCalls'] = list[i]['nbCalls'];
        result['nbRaises'] = list[i]['nbRaises'];
        total = result['nbFolds'] + result['nbCalls'] + result['nbRaises'];
      }
    }
    createMovesChart(result, total);
  }

  /**
   *  Creates the rulesChart with the data that is prepared by the
   *  parseRuleChartData() function. Also the username will be set in the
   *  rulesUsernameView.
   */
  function createRulesChart(data, total) {
    $('#rulesUsernameView').html(Client.username);
    var information = [], i = 0;
    for(index in data) {
      var value = Math.round((data[index]/total)*100);
      var label = index + ' - ' + value + '%';
      var element = {
        value: value,
        color: COLORS[i],
        highlight: COLORS[i],
        label: label
      }
      information.push(element);
      i++;
    }
    var options = {
      tooltipTemplate: "<%= label %>",
      showTooltips: true,
      animation: false
    }
    if (rulesChart != null) rulesChart.destroy();
    var context = $('#RulesChart').get(0).getContext('2d');
    rulesChart = new Chart(context).Pie(information, options);
  }
  function parseRuleChartData(raw) {
    var list = raw['result']['player'];
    var result = {};
    var total = 0;
    for(var i = 0; i < list.length; i++) {
      if (list[i]['name'] == Client.username) {
        var rules = list[i]['rulesUsed'];
        for(var j = 0; j < rules.length; j++) {
          result[rules[j]['name']] = rules[j]['times'];
          total += rules[j]['times'];
        }
      }
    }
    createRulesChart(result, total);
  }

  /**
   *  This function fetches the data and generates the three different
   *  pie charts that will be displayed in the right side bar.
   */
  function fetchSideBarGraphsData() {
    $.ajax({ url: DATASOURCE, method: 'GET', success: function(result) {
      try {
        var data = $.parseJSON(result);
        parseCalculationTimePieChartData(data);
        parseMoveChartData(data);
        parseRuleChartData(data);
      } catch(error) {
        console.error('Data received but error!: ' + error);
      }
    }, error: function(error) {
      console.error('Unable to fetch data!: ' + error);
    }});
  }

  /**
   *  Make sure the data keeps updating, also call the fetchSideBarGraphsData()
   *  function once so there is no delay before the first draw.
   */
  setInterval(function() {
    fetchSideBarGraphsData();
  }, 2500);
  fetchSideBarGraphsData();

  // TODO: THIS SHOULD BE DEFINED IN THE PARENT
  var COLORS = [
    'rgb(25, 180, 145)',
    'rgb(41, 197, 102)',
    'rgb(45, 141, 214)',
    'rgb(144, 79, 173)',
    'rgb(46, 64, 83)',
    'rgb(22, 150, 122)',
    'rgb(35, 164, 85)',
    'rgb(36, 117, 176)',
    'rgb(131, 60, 163)',
    'rgb(39, 54, 70)'
  ];

</script>
