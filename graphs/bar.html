
<!--  In order to load this file into the main page, make sure that the
      Highcharts library is included before this file. If this is not the
      case, the charts won't render and might even cause all the JS to
      stop executing on the parent page.
      TODO: Include it here? But might cause problems with multiple
            includes in different modules.
      INCLUDE SCRIPTS/HIGHCHARTS.JS   -->

<h3>Rekeningstijden per speler</h3>
<canvas id="CalculationTime" width="200" height="200"></canvas>
<script>

  var calculationTimeChart = null;

  var COLORS = [
    'rgb(25, 180, 145)',
    'rgb(41, 197, 102)',
    'rgb(45, 141, 214)',
    'rgb(144, 79, 173)',
    'rgb(46, 64, 83)',
    'rgb(22, 150, 122)',
    'rgb(35, 164, 85)',
    'rgb(36, 117, 176)',
    'rgb(131, 60, 163)',
    'rgb(39, 54, 70)'
  ];

  function createCalculationTimePieChart(data, total) {
    var information = [], i = 0;
    for(index in data) {
      var value = Math.round((data[index]/total)*100);
      var label = index + ' - ' + value + '%';
      var element = {
        value: value,
        color: COLORS[i],
        highlight: COLORS[i],
        label: label
      }
      information.push(element);
      i++;
    }
    var options = {
      tooltipTemplate: "<%= label %>",
      showTooltips: true,
      animation: false
    }
    if (calculationTimeChart != null) {
      calculationTimeChart.destroy();
    }
    var context = $('#CalculationTime').get(0).getContext('2d');
    calculationTimeChart = new Chart(context).Pie(information, options);
  }

  function parseCalculationTimePieChartData(raw) {
    var list = raw['result']['player'];
    var result = {};
    var total = 0;
    for(var i = 0; i < list.length; i++) {
      result[list[i]['name']] = list[i]['time used'];
      total += list[i]['time used'];
    }
    createCalculationTimePieChart(result, total);
  }

  function fetchCalculationTimePieChartData() {
    $.ajax({ url: DATASOURCE, method: 'GET', success: function(result) {
      try {
        var data = $.parseJSON(result);
        parseCalculationTimePieChartData(data);
      } catch(error) {
        console.error('Data received but error!: ' + error);
      }
    }, error: function(error) {
      console.error('Unable to fetch data!: ' + error);
    }});
  }

  setInterval(function() {
    fetchCalculationTimePieChartData();
  }, 2500);
  fetchCalculationTimePieChartData();







</script>
