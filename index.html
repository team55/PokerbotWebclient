<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pokerdemo, webclient</title>

  <!-- Include the Blockly library. -->
  <script src="blockly/blockly_compressed.js"></script>
  <script src="blockly/blocks_compressed.js"></script>
  <script src="blockly/msg/js/en.js"></script>
  <script src="blocks_poker.js"></script>
  <script src="generator_prolog.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="jquery-1.11.3.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.js"></script>


  <script src="scripts/Logger.js"></script>
  <script src="scripts/API.js"></script>
  <script src="scripts/Client.js"></script>
  <script src="scripts/Server.js"></script>


  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"/>
  <link rel="stylesheet" href="css/stylesheet.css"/>

  <style>
    .dbblue {
      background-color: blue;
    }
    .dbred {
      background-color: red;
    }
    .dbgreen {
      background-color: green;
    }
    .dbpurple {
      background-color: purple;
    }
    .dbyellow {
      background-color: yellow;
    }


    .topgraph {
      text-align: center;
      font-style: italic;
    }

    .rightinfo {
      text-align: center;
    }

    .rightinfo > p {
      margin: 25px;
    }

    .cleancol {
      padding: 0;
    }

    .grid {
      margin-top: 0 !important;
      margin-bottom: 100px !important;
    }

    .connect > span > span > input, .connect > span > span > span {
      margin-top: 15px !important;
    }

    .dimmer {
      background-color: rgba(0,0,0,0.95) !important;
    }

    .error {
      color: #e74c3c;
      font-style: italic;
      margin-top: 15px;
    }

    .log {
      color: #3498db;
      font-style: italic;
      margin-top: 15px;
    }



  </style>



</head>
<body>

  <div class="ui grid">

    <!-- Sign in and status div -->
    <div class="sixteen wide column cleancol">
      <span id="toggledimmer" class="ui teal button">Ga naar een tafel</span>
      <span id="tablestatus"></span>
    </div>

    <!-- Top data div -->
    <div class="sixteen wide column topgraph">
      <p> Wanneer je verbonden bent met een tafel, <br /> zullen de resultaten
          hier worden weergegeven.</p>
    </div>

    <!-- Blockly Interface -->
    <div class="eleven wide column dbpurple">data</div>

    <!-- Welcome div -->
    <div class="five wide column rightinfo">
      <h1>Welkom!</h1>
      <p> Via deze weg kun je voor het eerst kennis maken met programmeren door
          een eigen pokerbot te maken. Heb je al ervaring met dit programma?
          Verbind dan meteen met een tafel door te knop links bovenaan te
          gebruiken. Toch eerst wat meer uitleg? Start dan de stapsgewijze
          tutorial door middel van de knop onderaan deze uitleg. </p>
      <div class="ui teal button">Start tutorial</div>
    </div>
    <div class="sixteen wide column bottomdata"></div>
  </div>






  <!-- Control panel to save/load workspaceand to send rules to the Server. -->
  <div id="controls" class="controls">
    <h2>Create a custom Pokerbot!</h2>
    <button class="ui button" onclick="saveWorkspace()">Save configuration</button>
    <button class="ui button" onclick="loadWorkspace()">Load configuration</button>
    <br /><br />
    <button class="ui button" onclick="submit()">Send rules!</button>
    <button class="ui button" onclick="Client.signout()">Sign out</button>
    <br /><br />
    <button class="ui button" onclick="Client.toggleprolog()">Toggle Prolog</button>
    <br />
    <div id="status"></div>
  </div>

  <!-- Here u see a preview of the Prolog code that will be sent to the Server. -->
  <div id="preview">
    <textarea id="textarea" rows="8" cols="30"></textarea>
  </div>

  <!-- The div with the blockly in it! This should still be made custom. -->
  <div id="workDiv" style="text-align:center;margin:0 auto;width:90%;">
    <div id="blocklyDiv" style="height: 680px; width: 800px;margin:0 auto;"></div>
    <xml id="toolbox" style="display: none">
      <category name="Situations">
        <block type="is_preflop"></block>
        <block type="is_flop"></block>
        <block type="is_turn"></block>
        <block type="is_river"></block>
        <block type="is_postflop"></block>
        <block type="is_small_blind"></block>
        <block type="is_big_blind"></block>
        <block type="is_dealer"></block>
        <block type="logic_boolean"></block>
      </category>
      <category name="Amounts">
        <block type="stacksize"></block>
        <block type="potsize"></block>
        <block type="active_players"></block>
        <block type="non_allin_active_players"></block>
        <block type="amount_to_call"></block>
        <block type="max_profit"></block>
        <block type="min_raise"></block>
        <block type="max_raise"></block>
        <block type="number_of_raises"></block>
        <block type="random"></block>
        <block type="math_number"></block>
      </category>
      <category name="Comparators">
        <block type="greater_then"></block>
        <block type="greater_then_or_equal"></block>
        <block type="less_then"></block>
        <block type="less_then_or_equal"></block>
        <block type="equals"></block>
        <block type="and"></block>
        <block type="or"></block>
        <block type="not"></block>
      </category>
      <category name="Operations">
        <block type="add"></block>
        <block type="substract"></block>
        <block type="multiply"></block>
        <block type="divide"></block>
      </category>
      <category name="Sequence">
        <block type="custom_if"></block>
      </category>
      <category name="Actions">
        <block type="poker_call"></block>
        <block type="poker_fold"></block>
        <block type="poker_raise"></block>
      </category>
      <category name="Cards">
        <block type="poker_cards"></block>
        <block type="poker_card">
          <value name="arg_color">
            <block type="poker_color_any"></block>
          </value>
          <value name="arg_rank">
            <block type="poker_rank_any"></block>
          </value>
        </block>
        <block type="poker_color"></block>
        <block type="poker_color_same">
          <value name="num">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
        </block>
        <block type="poker_rank"></block>
        <block type="poker_rank_same">
          <value name="num">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
        </block>
        <block type="poker_rank_incr">
          <value name="num">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
          <value name="incr">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
        </block>
      </category>
    </xml>
    <xml id="startBlocks" style="display: none">
      <block type="custom_if" x="25" y="25">
        <value name="IF0">
          <block type="logic_boolean">
            <field name="BOOL">TRUE</field>
          </block>
        </value>
        <statement name="DO0">
          <block type="poker_call"></block>
        </statement>
      </block>
    </xml>
  </div>

  <div id="playDiv">
  </div>

  <script>

    var workspace;
    var initializeBlocks = function() {
      // blockly stuff
      workspace = Blockly.inject('blocklyDiv',
          {media: 'blockly/media/',
           toolbox: document.getElementById('toolbox')});
      Blockly.Xml.domToWorkspace(workspace,
              document.getElementById('startBlocks'));
      function myUpdateFunction() {
        var code = Blockly.Prolog.workspaceToCode(workspace);
        document.getElementById('textarea').value = code;
      }
      workspace.addChangeListener(myUpdateFunction);
    }

    initializeBlocks();


    // buttons
    function connect() {
      var username = $('#inputUser').val();
      var table = $('#inputTable').val();
      Server.connect(username, table);
      /*
       * Same Origin Policy disallows... only when run on same server
      // send hello to webserver, if OK continue
      $.ajax({
        method: "POST",
        url: "http://bear.cs.kuleuven.be/pokerdemo/server/hello.php",
        data: { tableName: table, playerName: user }
      })
        .done(function( msg ) {
          alert( "Got reply: " + msg );
        });
        *
        */
      // Fake with 'sending' iframe for now
      //var faker = "<iframe src=\"http://bear.cs.kuleuven.be/pokerdemo/server/hello.php?tableName="+table+"&playerName="+user+"\">This website uses iframes to show the game results.</iframe>";
      //$('#debugDiv').html(faker);

      // Receiving iframe
      //var code = "<iframe src=\"http://bear.cs.kuleuven.be/pokerdemo/server/watchTable.php?tableName="+table+"\">This website uses iframes to show the game results.</iframe>";
      //$('#playDiv').html(code);
    }
    function submit() {
      var user = $('#inputUser').val();
      var table = $('#inputTable').val();
      // Generate Prolog code and submit it.
      var code = Blockly.Prolog.workspaceToCode(workspace);

      // send to server
      var faker = "<iframe src=\"http://bear.cs.kuleuven.be/pokerdemo/server/joinTable.php?tableName="+table+"&playerName="+user+"&description="+encodeURIComponent(code)+"\">This website uses iframes to show the game results.</iframe>";
      $('#debugDiv').html(faker);
    }

    function saveWorkspace() {
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      alert(xml_text);
    }

    function loadWorkspace() {
      var result = prompt("Enter xml");
      var dom = Blockly.Xml.textToDom(result);
      Blockly.Xml.domToWorkspace(workspace, dom);
    }
  </script>




  <!-- This is the content dimmer to connect to a table -->
  <div class="ui page dimmer">
    <div class="content">
      <div class="center">
        <div class="ui two column middle aligned very relaxed stackable grid wlimit">
          <div class="center aligned column">
            <h1>Plaatsnemen</h1>
            <p class="ui inverted connect">
              <span class="ui form">
                <span class="field">
                  <input id="username" type="text" placeholder="Gebruikersnaam">
                </span>
                <span class="field">
                  <input id="tablename" type="text" placeholder="Tafelnaam">
                </span>
                <span class="field">
                  <span id="connectbtn" class="ui teal submit button">Neem plaats</span>
                </span>
                <div id="connecterror" class="error"><br></div>
              </span>
            </p>
          </div>
          <div class="ui inverted vertical divider">
            OF
          </div>
          <div class="center aligned column">
            <h1>Tafel aanmaken</h1>
            <p class="ui inverted connect">
              <span class="ui form">
                <span class="field">
                  <input id="tablecreatename" type="text" placeholder="Tafelnaam">
                </span>
                <span class="field">
                  <input id="tablepassword" type="password" placeholder="Wachtwoord">
                </span>
                <span class="field">
                  <select id="players" class="ui search dropdown">
                    <option value="">Aantal plaatsen</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </span>
                <span class="field">
                  <button id="createtable" class="ui teal submit button">Maak tafel</button>
                </span>
                <div id="createerror" class="error"><br></div>
                <div id="createlog" class="log"><br></div>
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $('#connectbtn').click(function() {
      var username = $('#username').val();
      var table = $('#tablename').val();
      Server.connect(username, table);
    });
    $('#createtable').click(function(e) {
      if ($('#players').val() === '' || $('#tablecreatename').val() == '' || $('#tablepassword').val() == '') {
        $('#createerror').html('Geef een tafelnaam, wachtwoord én aantal plaatsen.');
      } else {
        var table = $("#tablecreatename").val();
        var password = $('#tablepassword').val();
        var players = parseInt($('#players').val(), 10);
        API.createTable(table, password, players);
      }
      console.log('Hello');
      console.log($('#tablecreatename').val());
      console.log($('#players').val());
      console.log
      //
      //$('.ui.modal').modal('show');
    });
    $('#toggledimmer').click(function(e) {
      $('.ui.page.dimmer').dimmer('show');
    });
  </script>


</body>
</html>
